@startuml Order Sequence Diagram
title Valider la commande (Checkout) - Diagramme de séquence
autonumber
hide footbox

actor "Utilisateur" as U

boundary "UI (CLI)\nUiCart" as UiCart
boundary "UI (CLI)\nUiOrder" as UiOrder

control "CartService" as CartSvc
control "OrderService" as OrderSvc

database "CartDao (JDBC)" as CartDao
database "ClientDao (JDBC)" as ClientDao
database "OrderDao (JDBC)" as OrderDao
database "DB (MariaDB)" as DB


== Déclenchement ==
U -> UiCart : Choisit "4) Valider / Commander"
activate UiCart

UiCart -> CartSvc : getOrCreateCart(userId)
activate CartSvc

CartSvc -> CartDao : getOrCreateCartId(userId)
activate CartDao
CartDao -> DB : SELECT cart.id WHERE user_id=?
activate DB
DB --> CartDao : cartId / none
deactivate DB

alt cart not found
  CartDao -> DB : INSERT cart(user_id)
  activate DB
  DB --> CartDao : cartId
  deactivate DB
end
deactivate CartDao

CartSvc -> CartDao : findByUserId(userId)
activate CartDao
CartDao -> DB : SELECT cart + items JOIN training
activate DB
DB --> CartDao : cart(header + items)
deactivate DB
CartDao --> CartSvc : Cart
deactivate CartDao

CartSvc --> UiCart : Cart
deactivate CartSvc

alt Panier vide
  UiCart -> U : Message "Le panier est vide."
  deactivate UiCart
  return
else Panier non vide
  UiCart -> UiOrder : askClient(sc, orderService)
  activate UiOrder
  UiOrder -> U : Choisir un client existant\nou créer un nouveau
  U --> UiOrder : Infos client (draft)
  UiOrder --> UiCart : Client draft
  deactivate UiOrder
end

UiCart -> U : Confirmation "Confirmer la commande ?"
alt Annuler
  deactivate UiCart
  return
else Confirmer
  UiCart -> OrderSvc : checkout(userId, clientDraft)
  activate OrderSvc

  == Validation panier ==
  OrderSvc -> CartSvc : requireNonEmptyCart(userId)
  activate CartSvc

  CartSvc -> CartDao : getOrCreateCartId(userId)
  activate CartDao
  CartDao -> DB : SELECT/INSERT cart.id
  activate DB
  DB --> CartDao : cartId
  deactivate DB
  deactivate CartDao

  CartSvc -> CartDao : findByUserId(userId)
  activate CartDao
  CartDao -> DB : SELECT cart + items JOIN training
  activate DB
  DB --> CartDao : Cart
  deactivate DB
  CartDao --> CartSvc : Cart
  deactivate CartDao

  CartSvc --> OrderSvc : Cart
  deactivate CartSvc

  alt cart empty (safety)
    OrderSvc --> UiCart : CartEmptyException
    UiCart -> U : Message "Le panier est vide."
    deactivate OrderSvc
    deactivate UiCart
    return
  end

  == Client: create or reuse (by email) ==
  OrderSvc -> ClientDao : findByEmail(email)
  activate ClientDao
  ClientDao -> DB : SELECT client WHERE email=?
  activate DB

  alt client exists
    DB --> ClientDao : Client
    deactivate DB
    ClientDao --> OrderSvc : Client
  else client not found
    DB --> ClientDao : empty
    deactivate DB

    ClientDao --> OrderSvc : Optional.empty
    deactivate ClientDao

    OrderSvc -> ClientDao : create(new Client(...))
    activate ClientDao
    ClientDao -> DB : INSERT client(...)
    activate DB
    DB --> ClientDao : clientId
    deactivate DB
    ClientDao --> OrderSvc : clientId

    OrderSvc -> ClientDao : findById(clientId)
    ClientDao -> DB : SELECT client WHERE id=?
    activate DB
    DB --> ClientDao : Client
    deactivate DB
    ClientDao --> OrderSvc : Client
  end
  deactivate ClientDao

  == Create order + lines (transaction) ==
  OrderSvc -> OrderDao : createOrderWithLines(order, lines)
  activate OrderDao

  OrderDao -> DB : BEGIN TRANSACTION
  activate DB
  DB --> OrderDao : ok
  deactivate DB

  OrderDao -> DB : INSERT `order`(...)
  activate DB
  DB --> OrderDao : orderId
  deactivate DB

  loop for each cart item
    OrderDao -> DB : INSERT order_line(...)\n(batch)
    activate DB
    DB --> OrderDao : ok
    deactivate DB
  end

  OrderDao -> DB : COMMIT
  activate DB
  DB --> OrderDao : ok
  deactivate DB

  OrderDao --> OrderSvc : orderId
  deactivate OrderDao

  alt orderId invalid
    OrderSvc --> UiCart : OrderException
    UiCart -> U : Message "Checkout failed"
    deactivate OrderSvc
    deactivate UiCart
    return
  end

  == Clear cart after success ==
  OrderSvc -> CartDao : getOrCreateCartId(userId)
  activate CartDao
  CartDao -> DB : SELECT/INSERT cart.id
  activate DB
  DB --> CartDao : cartId
  deactivate DB
  deactivate CartDao

  OrderSvc -> CartDao : clear(cartId)
  activate CartDao
  CartDao -> DB : DELETE FROM cart_item WHERE cart_id=?
  activate DB
  DB --> CartDao : ok
  deactivate DB
  deactivate CartDao

  == UI confirmation ==
  OrderSvc --> UiCart : Order(created with lines)
  deactivate OrderSvc

  UiCart -> U : "Commande créée ✅"\n(orderId, total)\n"Le panier a été vidé."
  deactivate UiCart
end

@enduml
